<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>PLC Chat Prototype</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #log  { border: 1px solid #ccc; padding: 1rem; height: 200px; overflow-y: auto; margin-top:1rem;}
    #msg  { width: 12rem; }
  </style>
</head>
<body>
  <h1>PLC チャット (ローカルプロトタイプ)</h1>

  <button id="logout">ログアウト</button><br/>

  <label>質問:</label>
  <input id="query" type="text" size="40" placeholder="例: D100 の不具合を調べて" />
  <button id="send">送信</button>

  <br/>
  <label>コメントCSV:</label>
  <input id="csv" type="file" accept=".csv" />
  <button id="upload">アップロード</button>

  <br/>
  <label>PLCプログラム:</label>
  <input id="prog-files" type="file" accept=".csv" multiple />
  <button id="prog-upload">アップロード</button>

  <pre id="log"></pre>

  <script>
    const socket = io({ withCredentials: true });
    const log = (txt) => { const p = document.getElementById("log"); p.textContent += txt + "\n"; p.scrollTop = p.scrollHeight; };

    async function uploadCommentsIfSelected() {
      const file = document.getElementById("csv").files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch('/api/comments', {method: 'POST', body: fd});
      if (!res.ok) {
        log("コメント読み込み失敗");
      }
    }

    document.getElementById("send").onclick = async () => {
      await uploadCommentsIfSelected();
      const text = document.getElementById("query").value;
      socket.emit("chat", { text });
      log(`You > ${text}`);
    };

    document.getElementById("logout").onclick = async () => {
      await fetch('/logout', {method: 'POST'});
      location.href = '/login.html';
    };

    document.getElementById("upload").onclick = async () => {
      const file = document.getElementById("csv").files[0];
      if (!file) { log("ファイルを選択してください"); return; }
      await uploadCommentsIfSelected();
      log("コメントを読み込みました");
    };

    document.getElementById("prog-upload").onclick = async () => {
      const files = document.getElementById("prog-files").files;
      if (files.length === 0) { log("ファイルを選択してください"); return; }
      const fd = new FormData();
      for (const f of files) {
        fd.append("files", f);
      }
      const res = await fetch('/api/programs', {method: 'POST', body: fd});
      if (res.ok) {
        const json = await res.json();
        log(`${json.count} 個のプログラムを読み込みました`);
      } else {
        log("プログラム読み込み失敗");
      }
    };

    socket.on("reply", (data) => log(`AI > ${data.text}`));
  </script>
</body>
</html>
