<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>PLC Chat Prototype</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #log  { border: 1px solid #ccc; padding: 1rem; height: 200px; overflow-y: auto; margin-top:1rem;}
    #msg  { width: 12rem; }
  </style>
</head>
<body>
  <h1>PLC チャット (ローカルプロトタイプ)</h1>

  <button id="logout">ログアウト</button><br/>

  <label>質問:</label>
  <input id="query" type="text" size="40" placeholder="例: D100 の不具合を調べて" />
  <button id="send">送信</button>

  <br/>
  <label>コメントCSV:</label>
  <input id="csv" type="file" accept=".csv" />

  <br/>
  <label>PLCプログラム:</label>
  <input id="prog-files" type="file" accept=".csv" multiple />

  <pre id="log"></pre>

  <script>
    const socket = io();
    const log = (txt) => { const p = document.getElementById("log"); p.textContent += txt + "\n"; p.scrollTop = p.scrollHeight; };

    document.getElementById("send").onclick = async () => {
      const text = document.getElementById("query").value;
      const readFile = (file) => new Promise(res => {
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.readAsText(file);
      });

      const cfile = document.getElementById("csv").files[0];
      const comment = cfile ? await readFile(cfile) : null;

      const pfiles = document.getElementById("prog-files").files;
      const programs = [];
      for (const f of pfiles) {
        programs.push({name: f.name, content: await readFile(f)});
      }

      socket.emit("chat", { text, comment, programs });
      log(`You > ${text}`);
    };

    document.getElementById("logout").onclick = async () => {
      await fetch('/logout', {method: 'POST'});
      location.href = '/login.html';
    };



    socket.on("reply", (data) => log(`AI > ${data.text}`));
  </script>
</body>
</html>
